<html>
<head>
  <title>Kachnicka</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
</head>
<body>
  <h1>Graph</h1>
  <div id="chart-container" style="position: relative; height: 70vh; width: 100%" />

  <script>
    Chart.defaults.global.animation.duration = 0

    const graph = (() => {
      let canvas = document.createElement("canvas")
      document.getElementById("chart-container").appendChild(canvas)
      let ctx = canvas.getContext('2d')
      let chartOptions = {
        type: 'line',
        data: {
          labels: [],
          datasets: []
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          spanGaps: false,
          elements: {
            line: {
              tension: 0.000001
            }
          },
          plugins: {
            filler: {
              propagate: false
            }
          },
          scales: {
            xAxes: [{
              display: true,
              ticks: {
                autoSkip: false
              }
            }],
            yAxes: [{
              display: true,
              beginAtZero: true
            }]
          }
        }
      }
      return new Chart(ctx, chartOptions)
    })()

    const refreshData = (chart, times, d_sizes, ds_sizes) => {
      chart.data.labels = times
      chart.data.datasets = [{
        label: 'Temperature (C)',
        data: d_sizes,
        backgroundColor: transparentize(colors.red),
        borderColor: colors.red,
        fill: false
      },
      {
        label: 'Data size (bytes)',
        data: ds_sizes,
        backgroundColor: transparentize(colors.blue),
        borderColor: colors.blue,
        fill: false
      }]
      chart.update()
    }

    const refresh = () => {
      fetch(`/meta?limit=${50}`)
      .then(response => response.json())
      .then(data => {
        let slice = data.reverse()
        let d_sizes = slice.map(item => item.Data)
        let ds_sizes = slice.map(item => item.DataSize)
        let times = slice.map(item => new Date(item.Time * 1000).toUTCString())

        refreshData(graph, times, d_sizes, ds_sizes)        
      })
    }

    const transparentize = (color, opacity) =>
      Color(color).alpha(!opacity ? 0.5 : 1 - opacity).rgbString()

    const colors = {
      red: "rgb(255, 99, 132)",
      blue: "rgb(54, 162, 235)"
    }

    window.addEventListener('load', () => {
      refresh()
      setInterval(refresh, 1000)
    }, true)

  </script>
</body>
</html>